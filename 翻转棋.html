<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>翻转棋</title>
    <script>
        var turn = 0;
        var blackCount = 2;
        var whiteCount = 2;
        var blackScore = 0;
        var whiteScore = 0;
        var lastMoveRow;
        var lastMoveCol;
        var size = 8;

        function mapPlayerTurnToPiece(turn){
            if(turn===0){
                return "⚫";
            }else{
                return "⚪️";
            }
        }

        function mapPieceToPlayerTurn(piece){
            if(piece==="⚫"){
                return 0;
            }else if (piece==="⚪️"){
                return 1;
            }else{
                return -1;
            }
        }

        function setBoardSize(){
            let newSize = document.getElementById("size").value;
            if(newSize<4){
                newSize = 4;
                document.getElementById("size").value = 4;
            }
            if(newSize>40){
                newSize = 40;
                document.getElementById("size").value = 40;
            }
            size = newSize;
            generateBoard();
        }

        function generateBoard(){
            let board = document.getElementById("board");
            boardHtml = "";
            for (let i = 0; i < size; i++) {
                boardHtml += "<tr>";
                for (let j = 0; j < size; j++){
                    let cellStartTag = "<td";
                    let cellOnClickStr = " onclick=placePiece("+i+","+j+")"
                    let cellId = " id="+i+"-"+j+">";
                    let cellEndTag = "</td>";
                    boardHtml += cellStartTag + cellOnClickStr + cellId+ cellEndTag;
                }
                boardHtml += "</tr>";
            }
            board.innerHTML = boardHtml;
            let center = Math.floor(size/2);
            document.getElementById((center-1)+"-"+(center-1)).innerHTML = "⚪️";
            document.getElementById((center-1)+"-"+center).innerHTML = "⚫";
            document.getElementById((center)+"-"+(center-1)).innerHTML = "⚫";
            document.getElementById((center)+"-"+(center)).innerHTML = "⚪️";
            markPossibleMoves(turn);
        }

        function noMoves(){
            for(let i = 0; i < size; i++){
                for (let j = 0; j < size; j++){
                    let cell = document.getElementById(i+"-"+j);
                    if(cell.classList.contains("valid")){
                        return false;
                    }
                }
            }
            return true;
        }

        function countPieces(){
            blackCount = 0;
            whiteCount = 0;
            for(let i=0; i<size; i++){
                for(let j = 0; j < size; j++){
                    let cell = document.getElementById(i+"-"+j);
                    if(cell.innerHTML==="⚫"){
                        blackCount++;
                    }else if(cell.innerHTML==="⚪️"){
                        whiteCount++;
                    }
                }
            }
            document.getElementById("piececount").innerHTML = "当前棋子数量:⚫ "+blackCount+"-"+whiteCount+" ⚪️";
        }

        function markPossibleMoves(turn){
            for(let i=0; i<size; i++){
                for(let j = 0; j < size; j++){
                    let cell = document.getElementById(i+"-"+j);
                    cell.classList.remove("valid");
                }
            }
            markUp(turn);
            markUpLeft(turn);
            markUpRight(turn);
            markDown(turn);
            markDownLeft(turn);
            markDownRight(turn);
            markLeft(turn);
            markRight(turn);
        }

        function markUp(turn){
            for(let i=0; i<size; i++){
                for(let j = 0; j < size; j++){
                    let cell = document.getElementById(i+"-"+j);
                    if(mapPieceToPlayerTurn(cell.innerHTML)===turn && cell.innerHTML !== ""){
                        let row = i-1;
                        let col = j;
                        while(row >= 0){
                            let cell2 = document.getElementById(row+"-"+col);
                            if(mapPieceToPlayerTurn(cell2.innerHTML)===turn && cell2.innerHTML !== ""){
                                break;
                            }
                            if(cell2.innerHTML===""){
                                let cell3 = document.getElementById((row+1)+"-"+col);
                                if(mapPieceToPlayerTurn(cell3.innerHTML)===(turn+1)%2 && cell3.innerHTML !== "") {
                                    cell2.classList.add("valid");
                                }
                                break;
                            }
                            row--;
                        }
                    }
                }
            }
        }

        function markUpLeft(turn){
            for(let i=0; i<size; i++){
                for(let j = 0; j < size; j++){
                    let cell = document.getElementById(i+"-"+j);
                    if(mapPieceToPlayerTurn(cell.innerHTML)===turn && cell.innerHTML !== ""){
                        let row = i-1;
                        let col = j-1;
                        while(row >= 0 && col >= 0){
                            let cell2 = document.getElementById(row+"-"+col);
                            if(mapPieceToPlayerTurn(cell2.innerHTML)===turn && cell2.innerHTML !== ""){
                                break;
                            }
                            if(cell2.innerHTML===""){
                                let cell3 = document.getElementById((row+1)+"-"+(col+1));
                                if(mapPieceToPlayerTurn(cell3.innerHTML)===(turn+1)%2 && cell3.innerHTML !== "") {
                                    cell2.classList.add("valid");
                                }
                                break;
                            }
                            row--;
                            col--;
                        }
                    }
                }
            }

        }

        function markUpRight(turn){
            for(let i=0; i<size; i++){
                for(let j = 0; j < size; j++){
                    let cell = document.getElementById(i+"-"+j);
                    if(mapPieceToPlayerTurn(cell.innerHTML)===turn && cell.innerHTML !== ""){
                        let row = i-1;
                        let col = j+1;
                        while(row >= 0 && col < size){
                            let cell2 = document.getElementById(row+"-"+col);
                            if(mapPieceToPlayerTurn(cell2.innerHTML)===turn && cell2.innerHTML !== ""){
                                break;
                            }
                            if(cell2.innerHTML===""){
                                let cell3 = document.getElementById((row+1)+"-"+(col-1));
                                if(mapPieceToPlayerTurn(cell3.innerHTML)===(turn+1)%2 && cell3.innerHTML !== "") {
                                    cell2.classList.add("valid");
                                }
                                break;
                            }
                            row--;
                            col++;
                        }
                    }
                }
            }

        }

        function markDown(turn){
            for(let i=0; i<size; i++){
                for(let j = 0; j < size; j++){
                    let cell = document.getElementById(i+"-"+j);
                    if(mapPieceToPlayerTurn(cell.innerHTML)===turn && cell.innerHTML !== ""){
                        let row = i+1;
                        let col = j;
                        while(row < size){
                            let cell2 = document.getElementById(row+"-"+col);
                            if(mapPieceToPlayerTurn(cell2.innerHTML)===turn && cell2.innerHTML !== ""){
                                break;
                            }
                            if(cell2.innerHTML===""){
                                let cell3 = document.getElementById((row-1)+"-"+col);
                                if(mapPieceToPlayerTurn(cell3.innerHTML)===(turn+1)%2 && cell3.innerHTML !== "") {
                                    cell2.classList.add("valid");
                                }
                                break;
                            }
                            row++;
                        }
                    }
                }
            }

        }

        function markDownLeft(turn){
            for(let i=0; i<size; i++){
                for(let j = 0; j < size; j++){
                    let cell = document.getElementById(i+"-"+j);
                    if(mapPieceToPlayerTurn(cell.innerHTML)===turn && cell.innerHTML !== ""){
                        let row = i+1;
                        let col = j-1;
                        while(row < size && col >= 0){
                            let cell2 = document.getElementById(row+"-"+col);
                            if(mapPieceToPlayerTurn(cell2.innerHTML)===turn && cell2.innerHTML !== ""){
                                break;
                            }
                            if(cell2.innerHTML===""){
                                let cell3 = document.getElementById((row-1)+"-"+(col+1));
                                if(mapPieceToPlayerTurn(cell3.innerHTML)===(turn+1)%2 && cell3.innerHTML !== "") {
                                    cell2.classList.add("valid");
                                }
                                break;
                            }
                            row++;
                            col--;
                        }
                    }
                }
            }

        }

        function markDownRight(turn){
            for(let i=0; i<size; i++){
                for(let j = 0; j < size; j++){
                    let cell = document.getElementById(i+"-"+j);
                    if(mapPieceToPlayerTurn(cell.innerHTML)===turn && cell.innerHTML !== ""){
                        let row = i+1;
                        let col = j+1;
                        while(row < size && col < size){
                            let cell2 = document.getElementById(row+"-"+col);
                            if(mapPieceToPlayerTurn(cell2.innerHTML)===turn && cell2.innerHTML !== ""){
                                break;
                            }
                            if(cell2.innerHTML===""){
                                let cell3 = document.getElementById((row-1)+"-"+(col-1));
                                if(mapPieceToPlayerTurn(cell3.innerHTML)===(turn+1)%2 && cell3.innerHTML !== "") {
                                    cell2.classList.add("valid");
                                }
                                break;
                            }
                            row++;
                            col++;
                        }
                    }
                }
            }

        }

        function markLeft(turn){
            for(let i=0; i<size; i++){
                for(let j = 0; j < size; j++){
                    let cell = document.getElementById(i+"-"+j);
                    if(mapPieceToPlayerTurn(cell.innerHTML)===turn && cell.innerHTML !== ""){
                        let row = i;
                        let col = j-1;
                        while(col >= 0){
                            let cell2 = document.getElementById(row+"-"+col);
                            if(mapPieceToPlayerTurn(cell2.innerHTML)===turn && cell2.innerHTML !== ""){
                                break;
                            }
                            if(cell2.innerHTML===""){
                                let cell3 = document.getElementById(row+"-"+(col+1));
                                if(mapPieceToPlayerTurn(cell3.innerHTML)===(turn+1)%2 && cell3.innerHTML !== "") {
                                    cell2.classList.add("valid");
                                }
                                break;
                            }
                            col--;
                        }
                    }
                }
            }
        }

        function markRight(turn){
            for(let i=0; i<size; i++){
                for(let j = 0; j < size; j++){
                    let cell = document.getElementById(i+"-"+j);
                    if(mapPieceToPlayerTurn(cell.innerHTML)===turn && cell.innerHTML !== ""){
                        let row = i;
                        let col = j+1;
                        while(col < size){
                            let cell2 = document.getElementById(row+"-"+col);
                            if(mapPieceToPlayerTurn(cell2.innerHTML)===turn && cell2.innerHTML !== ""){
                                break;
                            }
                            if(cell2.innerHTML===""){
                                let cell3 = document.getElementById(row+"-"+(col-1));
                                if(mapPieceToPlayerTurn(cell3.innerHTML)===(turn+1)%2 && cell3.innerHTML !== "") {
                                    cell2.classList.add("valid");
                                }
                                break;
                            }
                            col++;
                        }
                    }
                }
            }
        }

        function flipPieces(turn,row,col){
            flipUp(turn,row-1,col);
            flipUpLeft(turn,row-1,col-1);
            flipUpRight(turn,row-1,col+1);
            flipDown(turn,row+1,col);
            flipDownLeft(turn,row+1,col-1);
            flipDownRight(turn,row+1,col+1);
            flipLeft(turn,row,col-1);
            flipRight(turn,row,col+1);
        }

        function flipUp(turn,row,col){
            if(row===0 || (row>0 && document.getElementById((row-1) + "-" + col).innerHTML==="")){
                return;
            }
            let cell = document.getElementById(row + "-" + col);
            let row2 = row;
            let cell2 = cell;
            while ((cell2!=null && cell2.innerHTML !== mapPlayerTurnToPiece(turn)) && cell2.innerHTML !== "") {
                row2--;
                cell2 = document.getElementById(row2 + "-" + col);
            }
            if(cell2!=null &&mapPieceToPlayerTurn(cell2.innerHTML)===turn) {
                while ((cell != null && cell.innerHTML !== mapPlayerTurnToPiece(turn)) && cell.innerHTML !== "") {
                    cell.innerHTML = mapPlayerTurnToPiece(turn);
                    row--;
                    cell = document.getElementById(row + "-" + col);
                }
            }
        }

        function flipUpLeft(turn,row,col){
            if(row===0 || col===0 || (row>0 && col>0 && document.getElementById((row-1) + "-" + (col-1)).innerHTML==="")){
                return;
            }
            let cell = document.getElementById(row + "-" + col);
            let row2 = row;
            let col2 = col;
            let cell2 = cell;
            while ((cell2!=null && cell2.innerHTML !== mapPlayerTurnToPiece(turn)) && cell2.innerHTML !== "") {
                row2--;
                col2--;
                cell2 = document.getElementById(row2 + "-" + col2);
            }
            if(cell2!=null &&mapPieceToPlayerTurn(cell2.innerHTML)===turn) {
                while ((cell != null && cell.innerHTML !== mapPlayerTurnToPiece(turn)) && cell.innerHTML !== "") {
                    cell.innerHTML = mapPlayerTurnToPiece(turn);
                    row--;
                    col--;
                    cell = document.getElementById(row + "-" + col);
                }
            }
        }

        function flipUpRight(turn,row,col){
            if(row===0 || col===size-1 || (row>0 && col<size-1 && document.getElementById((row-1) + "-" + (col+1)).innerHTML==="")){
                return;
            }
            let cell = document.getElementById(row+"-"+col);
            let row2 = row;
            let col2 = col;
            let cell2 = cell;
            while ((cell2!=null && cell2.innerHTML !== mapPlayerTurnToPiece(turn)) && cell2.innerHTML !== "") {
                row2--;
                col2++;
                cell2 = document.getElementById(row2 + "-" + col2);
            }
            if(cell2!=null &&mapPieceToPlayerTurn(cell2.innerHTML)===turn) {
                while ((cell != null && cell.innerHTML !== mapPlayerTurnToPiece(turn)) && cell.innerHTML !== "") {
                    cell.innerHTML = mapPlayerTurnToPiece(turn);
                    row--;
                    col++;
                    cell = document.getElementById(row + "-" + col);
                }
            }
        }

        function flipDown(turn,row,col){
            if(row===size-1 || (row<size-1 && document.getElementById((row+1) + "-" + col).innerHTML==="")){
                return;
            }
            let cell = document.getElementById(row + "-" + col);
            let row2 = row;
            let cell2 = cell;
            while ((cell2!=null && cell2.innerHTML !== mapPlayerTurnToPiece(turn)) && cell2.innerHTML !== "") {
                row2++;
                cell2 = document.getElementById(row2 + "-" + col);
            }
            if(cell2!=null && mapPieceToPlayerTurn(cell2.innerHTML)===turn) {
                while ((cell != null && cell.innerHTML !== mapPlayerTurnToPiece(turn)) && cell.innerHTML !== "") {
                    cell.innerHTML = mapPlayerTurnToPiece(turn);
                    row++;
                    cell = document.getElementById(row + "-" + col);
                }
            }
        }

        function flipDownLeft(turn,row,col){
            if(row===size-1 || col===0 || (row<size-1 && col>0 && document.getElementById((row+1) + "-" + (col-1)).innerHTML==="")){
                return;
            }
            let cell = document.getElementById(row + "-" + col);
            let row2 = row;
            let col2 = col;
            let cell2 = cell;
            while ((cell2!=null && cell2.innerHTML !== mapPlayerTurnToPiece(turn)) && cell2.innerHTML !== "") {
                row2++;
                col2--;
                cell2 = document.getElementById(row2 + "-" + col2);
            }
            if(cell2!=null &&mapPieceToPlayerTurn(cell2.innerHTML)===turn) {
                while ((cell != null && cell.innerHTML !== mapPlayerTurnToPiece(turn)) && cell.innerHTML !== "") {
                    cell.innerHTML = mapPlayerTurnToPiece(turn);
                    row++;
                    col--;
                    cell = document.getElementById(row + "-" + col);
                }
            }
        }

        function flipDownRight(turn,row,col){
            if(row===size-1 || col===size-1 || (row<size-1 && col<size-1 && document.getElementById((row+1) + "-" + (col+1)).innerHTML==="")){
                return;
            }

            let cell = document.getElementById(row+"-"+col);
            let row2 = row;
            let col2 = col;
            let cell2 = cell;
            while ((cell2!=null && cell2.innerHTML !== mapPlayerTurnToPiece(turn)) && cell2.innerHTML !== "") {
                row2++;
                col2++;
                cell2 = document.getElementById(row2 + "-" + col2);
            }
            if(cell2!=null &&mapPieceToPlayerTurn(cell2.innerHTML)===turn) {
                while ((cell != null && cell.innerHTML !== mapPlayerTurnToPiece(turn)) && cell.innerHTML !== "") {
                    cell.innerHTML = mapPlayerTurnToPiece(turn);
                    row++;
                    col++;
                    cell = document.getElementById(row + "-" + col);
                }
            }
        }

        function flipLeft(turn,row,col){
            if(col===0 || (col>0 && document.getElementById(row + "-" + (col-1)).innerHTML==="")){
                return;
            }
            let cell = document.getElementById(row + "-" + col);
            let col2 = col;
            let cell2 = cell;
            while ((cell2!=null && cell2.innerHTML !== mapPlayerTurnToPiece(turn)) && cell2.innerHTML !== "") {
                col2--;
                cell2 = document.getElementById(row + "-" + col2);
            }
            if(cell2!=null &&mapPieceToPlayerTurn(cell2.innerHTML)===turn) {
                while ((cell != null && cell.innerHTML !== mapPlayerTurnToPiece(turn)) && cell.innerHTML !== "") {
                    cell.innerHTML = mapPlayerTurnToPiece(turn);
                    col--;
                    cell = document.getElementById(row + "-" + col);
                }
            }
        }

        function flipRight(turn,row,col){
            if(col===size-1 || (col<size-1 && document.getElementById(row + "-" + (col+1)).innerHTML==="")){
                return;
            }
            let cell = document.getElementById(row + "-" + col);
            let col2 = col;
            let cell2 = cell;
            while ((cell2!=null && cell2.innerHTML !== mapPlayerTurnToPiece(turn)) && cell2.innerHTML !== "") {
                col2++;
                cell2 = document.getElementById(row + "-" + col2);
            }
            if(cell2!=null &&mapPieceToPlayerTurn(cell2.innerHTML)===turn) {
                while ((cell != null && cell.innerHTML !== mapPlayerTurnToPiece(turn)) && cell.innerHTML !== "") {
                    cell.innerHTML = mapPlayerTurnToPiece(turn);
                    col++;
                    cell = document.getElementById(row + "-" + col);
                }
            }

        }

        function markLastMove(row,col){
            let cell = document.getElementById(row+"-"+col);
            cell.classList.add("newmove");
            lastMoveRow = row;
            lastMoveCol = col;
        }

        function unmarkLastMove(){
            let cell = document.getElementById(lastMoveRow+"-"+lastMoveCol);
            if(cell !== null) {
                cell.classList.remove("newmove");
            }
        }

        function placePiece(row,col){
            let cell = document.getElementById(row+"-"+col);
            if(cell.innerHTML==="" && cell.classList.contains("valid")) {
                unmarkLastMove();
                cell.innerHTML = mapPlayerTurnToPiece(turn);
                flipPieces(turn,row,col);
                countPieces();
                alternateTurns();
                markPossibleMoves(turn);
                markLastMove(row,col);
                if(noMoves()){
                    alternateTurns();
                    markPossibleMoves(turn);
                    markLastMove(row,col);
                    if(noMoves()){
                        endGame();
                    }
                }
            }

        }

        function alternateTurns(){
            turn = (turn+1)%2;
            document.getElementById("turn").innerHTML = "轮到"+mapPlayerTurnToPiece(turn)+"了";
        }

        function clearScores(){
            document.getElementById("scores").innerHTML = "当前比分:⚫ 0-0 ⚪️";
        }

        function restart(){
            turn = 0;
            generateBoard();
            document.getElementById("turn").innerHTML = "轮到⚫了";
            document.getElementById("piececount").innerHTML = "当前棋子数量:⚫ 2-2 ⚪️";
            document.getElementById("winner").innerHTML = "";
        }

        function endGame(){
            if(blackCount>whiteCount){
                document.getElementById("winner").innerHTML = "⚫赢了!"
                blackScore++;
            }else if(blackCount<whiteCount){
                document.getElementById("winner").innerHTML = "⚪️赢了!"
                whiteScore++;
            }else{
                document.getElementById("winner").innerHTML = "双方平局！";
            }
            document.getElementById("scores").innerHTML = "当前比分:⚫ "+blackScore+"-"+whiteScore+" ⚪️";
        }

    </script>
    <style>
        #gamecontainer{
            background-color: lightgreen;
            text-align: center;
            place-items: center;
        }

        #utilities{
            display: flex;
        }
        #infopanel{
            background-color: #23d623;
            border: 3px solid black;
            width: 350px;
        }
        #boardsettings{
            background-color: #23d623;
            border: 3px solid black;
            width: 350px;
        }
        h1{
            font-size: 50px;
            margin-top: 2px;
            margin-bottom: 2px;
        }

        p{
            font-size: 20px;
            margin-top: 2px;
            margin-bottom: 2px;
        }
        #board{
            background-color: black;
            border: 2px solid black;
        }
        td{
            border: 2px solid black;
            font-size: 35px;
            width: 50px;
            height: 50px;
            text-align: center;
            background-color: green;
        }
        .valid{
            background-color: lightblue;
        }
        .newmove{
            background-color: red;
        }
        p{
            font-size: 25px;
        }
        .input{
            width: 100px;
            height: 25px;
            font-size: 25px;
        }
        .g1{
            height: 40px;
            font-size: 25px
        }
    </style>
</head>
<body onload="generateBoard()">
<div id="gamecontainer">
    <h1>翻转棋</h1>
    <p>如果棋盘显示不佳建议缩小网页</p>
    <table id="board"></table>
    <br>
    <div id="utilities">
        <div id="infopanel">
            <p id="turn">轮到⚫了</p>
            <p id="piececount">当前棋子数量:⚫ 2-2 ⚪️</p>
            <p id="scores">当前比分:⚫ 0-0 ⚪️</p>
            <p id="winner"></p>
            <button class = "g1" onclick="restart()">新一局</button>
            <button class = "g1" onclick="clearScores()">重置比分</button>
        </div>
        <div id="boardsettings">
            <p>调整棋盘大小</p>
            <p>棋盘大小(4-40)<input type="number" value="8" class="input" id="size"> <button class="g1" onclick="setBoardSize()">调整</button></p>
        </div>
    </div>
</div>

</body>
</html>